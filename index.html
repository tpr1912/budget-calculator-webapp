<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapid Value Calculator</title> <!-- Changed title as requested -->
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text */
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.75rem;
        }
        .subsection-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4b5563;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .input-field {
            padding: 0.6rem 0.8rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .table-header th {
            background-color: #e5e7eb;
            padding: 0.8rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #4b5563;
            border-bottom: 1px solid #d1d5db;
        }
        .table-row td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .table-row:last-child td {
            border-bottom: none;
        }
        .total-row td {
            font-weight: 600;
            background-color: #f3f4f6;
        }
        .summary-box {
            background-color: #ecf0f1; /* Lighter grey for summary */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .summary-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .surplus {
            color: #10b981; /* Green for positive surplus */
        }
        .deficit {
            color: #ef4444; /* Red for deficit */
        }
        .frequency-select {
            appearance: none; /* Remove default arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='currentColor' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem; /* Make space for the custom arrow */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            z-index: 1000;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-width: 300px;
        }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none; /* Hidden by default */
        }
        .message-box button {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .message-box button:hover {
            background-color: #4338ca;
        }

        /* Sticky header styles */
        .sticky-header-wrapper {
            position: sticky;
            top: 0;
            z-index: 100; /* Ensure it stays above other content */
            background-color: #f3f4f6; /* Match body background or set to white */
            padding-top: 1rem; /* Add some space above the sticky element */
            padding-bottom: 1rem; /* Add some space below the sticky element */
            border-bottom: 1px solid #e5e7eb; /* Optional: A subtle line to separate */
            margin-bottom: 2rem; /* Ensure space before content below it */
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db;
        let auth;
        let userId = 'default-user-id'; // Default userId, will be updated on auth
        let appId;
        let isAuthReady = false; // Flag to ensure Firestore operations happen after auth

        // Function to display custom message box
        function showMessageBox(message) {
            const msgBox = document.getElementById('messageBox');
            const msgBoxText = document.getElementById('messageBoxText');
            const msgBoxOverlay = document.getElementById('messageBoxOverlay');
            msgBoxText.textContent = message;
            msgBox.style.display = 'flex';
            msgBoxOverlay.style.display = 'block';
        }

        // Function to hide custom message box
        function hideMessageBox() {
            const msgBox = document.getElementById('messageBox');
            const msgBoxOverlay = document.getElementById('messageBoxOverlay');
            msgBox.style.display = 'none';
            msgBoxOverlay.style.display = 'none';
        }
        window.hideMessageBox = hideMessageBox; // Make it globally accessible

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            try {
                // Accessing global variables provided by the Canvas environment
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    console.warn("Firebase config is missing or incomplete. Data persistence will not work.");
                    showMessageBox("Error: Firebase configuration missing. Data will not be saved. You can still use the tool for calculations during this session.");
                    // Continue with initial data rendering even if Firebase init fails
                    initializeBudgetData();
                    renderAllData();
                    return; // Exit here, no need to proceed with Firebase app initialization or auth
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated user ID:", userId);
                        document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        setupFirestoreListener(); // Start listening for data once authenticated
                    } else {
                        // Attempt to sign in with custom token or anonymously
                        if (typeof __initial_auth_token !== 'undefined') {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                // Fallback to anonymous sign-in if custom token fails
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageBox("Error initializing application. Data persistence might be affected. You can still use the tool for calculations during this session.");
                // Ensure initial data rendering happens even if there's a Firebase initialization error
                initializeBudgetData();
                renderAllData();
            }
        }

        // Object to hold all budgeting data
        // Default structure, which will be populated or merged with loaded data
        const defaultBudgetData = {
            income: [
                { name: 'Salary After Tax (1)', amount: 0, frequency: 'Weekly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Salary After Tax (2)', amount: 0, frequency: 'Weekly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Casual or Part Time Salary', amount: 0, frequency: 'Weekly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Allowance\'s', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Interest on Savings', amount: 0, frequency: 'Fortnightly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Interest on Investments', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Dividends', amount: 0, frequency: 'Weekly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Rent from Property', amount: 0, frequency: 'Weekly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Board', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other Income', amount: 0, frequency: 'Fortnightly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 }
            ],
            basicExpenses: [
                // Housing
                { name: 'Mortgage', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Board', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Rent', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Maintenance
                { name: 'Security', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Home Maintenance & Repairs', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Major Improvements', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Gardens and Fences', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Pest Control', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Electrical and Furniture Replacement', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Linen and Utensils', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Swimming Pool', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Maintenance)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Food
                { name: 'Groceries', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Bought Meals', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Coffee\'s Out & Snacks', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Food)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Educational & Professional
                { name: 'Study Course Fees', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Professional Subscriptions', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Student Union Fees', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'School Uniforms', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Equipment and Tools', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Books & Stationary', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'School Fees', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Special Tuition (eg Music Lessons)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Excursions', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Child Care', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Educational)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Utilities
                { name: 'Rates & Water', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Body Corporate', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Electricity / Gas', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Home Phone', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Mobile Phone', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Internet', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Utilities)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Transport
                { name: 'Petrol', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Registration', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Motor Association', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Maintenance & Repairs (Transport)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Public Transport', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Parking Fees', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Transport)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Health & Medical
                { name: 'Dentist', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Doctor', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Optometrist', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Chemist', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Chiropractor', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Physiotherapist', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Specialists', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Health)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Insurance
                { name: 'Home & Contents', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Medical (Insurance)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Vehicle (Insurance)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Boat & Caravan', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Life (Insurance)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Income Protection', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Insurance)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Clothing & Grooming
                { name: 'Work Clothing or Uniform', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Social Clothing', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Sports Clothing', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Footwear', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Haircare', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Makeup & Toiletries', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 }
            ],
            lifestyleExpenses: [
                // Holiday & Travel
                { name: 'Travel fares & Fuel', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Accommodation', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Meals (Holiday)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Sightseeing', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Holiday)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Gifts & Donations
                { name: 'Donations', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Birthday Gifts', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Birthday Parties', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Christmas Gifts', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Work related Gifts', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Aniversaries', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Weddings', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Births and Christenings', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Special Occasions', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Pocket Money', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Gifts)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Pets
                { name: 'Food (Pets)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Vet Fees', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Medication and Treatment (Pets)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Registration (Pets)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Pets)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Entertainment
                { name: 'Movies & Concerts', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Video Hire', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Music / CD\'s', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Exhibitions and displays', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Eating out', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Takeaway Meals', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Club Fees', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Newspapers/magazines/books', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Entertainment)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Hobbies & Sports
                { name: 'Equipment Purchases', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Equipment Hire', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Fees (Hobbies)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Club Memberships (Hobbies)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Hobbies)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                // Personal
                { name: 'Alcohol', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Cigarettes', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other (Personal)', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 }
            ],
            loanRepayments: [
                { name: 'Car Loan', amount: 0, frequency: 'Weekly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Credit Cards', amount: 0, frequency: 'Fortnightly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Store Cards', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Buy Now Pay Later', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Personal Bank Loan', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Personal Loan', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Other Loan', amount: 0, frequency: 'Yearly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 }
            ],
            // NEW: Savings Goals
            savingsGoals: [
                { name: 'Emergency Fund', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Retirement Savings', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'House Deposit', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'New Car Fund', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Holiday Fund', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Investment Account', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 },
                { name: 'Education Fund', amount: 0, frequency: 'Monthly', weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 }
            ],
            taxCalc: {
                beforeTaxAmount: 55000,
                taxAmount: 0,
                afterTaxAmount: 0
            },
            summaryFrequency: 'Monthly' // New property for summary display frequency
        };

        // This will hold the current state of the budget data, initially a deep copy of defaults
        window.budgetData = JSON.parse(JSON.stringify(defaultBudgetData));

        // --- Core Calculation Logic ---

        // Function to calculate all four frequencies (weekly, fortnightly, monthly, yearly)
        window.calculateAmounts = (amount, frequency) => {
            const parsedAmount = parseFloat(amount);
            if (isNaN(parsedAmount) || parsedAmount < 0) {
                return { weekly: 0, fortnightly: 0, monthly: 0, yearly: 0 };
            }

            let yearlyAmount = 0;
            switch (frequency) {
                case 'Weekly': yearlyAmount = parsedAmount * 52; break;
                case 'Fortnightly': yearlyAmount = parsedAmount * 26; break;
                case 'Monthly': yearlyAmount = parsedAmount * 12; break;
                case 'Yearly': yearlyAmount = parsedAmount * 1; break;
                default: yearlyAmount = parsedAmount * 12; // Default to monthly if frequency is unknown
            }

            return {
                weekly: yearlyAmount / 52,
                fortnightly: yearlyAmount / 26,
                monthly: yearlyAmount / 12,
                yearly: yearlyAmount
            };
        };

        // New Zealand Tax Brackets (Updated to reflect changes from 31 July 2024)
        const nzTaxBrackets = [
            { income: 15600, rate: 0.105 },
            { income: 53500, rate: 0.175 },
            { income: 78100, rate: 0.30 },
            { income: 180000, rate: 0.33 },
            { income: Infinity, rate: 0.39 } // For incomes above $180,000
        ];

        // Function to calculate tax
        window.calculateTax = (income) => {
            let tax = 0;
            let remainingIncome = income;

            for (let i = 0; i < nzTaxBrackets.length; i++) {
                const bracket = nzTaxBrackets[i];
                const lowerBound = (i === 0) ? 0 : nzTaxBrackets[i - 1].income;
                const upperBound = bracket.income;

                if (remainingIncome <= 0) break;

                // Calculate income within the current bracket
                const incomeInBracket = Math.min(remainingIncome, upperBound - lowerBound);

                // Add tax for this bracket
                tax += incomeInBracket * bracket.rate;

                remainingIncome -= incomeInBracket;
            }
            return tax;
        };

        // --- Rendering Functions ---

        // Helper to create a single table row HTML for an item
        function renderItemRowHtml(item, originalIndex, category, isRemovable = true) {
            const displayAmount = isNaN(item.amount) ? '0.00' : item.amount.toFixed(2); // Format amount for display

            let removeButton = '';
            if (isRemovable) {
                removeButton = `
                    <button onclick="removeBudgetItem('${category}', ${originalIndex})"
                            class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md transition-colors duration-200 text-sm">
                        Remove
                    </button>
                `;
            }

            return `
                <tr class="table-row">
                    <td class="w-1/3">
                        <input type="text" value="${item.name || ''}" placeholder="Enter Name"
                               class="input-field"
                               oninput="updateBudgetItemName('${category}', ${originalIndex}, this.value)">
                    </td>
                    <td class="w-1/4">
                        <input type="number" step="0.01" value="${displayAmount}"
                            class="input-field amount-input"
                            data-category="${category}" data-index="${originalIndex}"
                            oninput="handleAmountInput(this)" onblur="handleAmountBlur(this)">
                    </td>
                    <td class="w-1/4">
                        <select class="input-field frequency-select"
                            data-category="${category}" data-index="${originalIndex}"
                            onchange="handleFrequencyChange(this)">
                            <option value="Weekly" ${item.frequency === 'Weekly' ? 'selected' : ''}>Weekly</option>
                            <option value="Fortnightly" ${item.frequency === 'Fortnightly' ? 'selected' : ''}>Fortnightly</option>
                            <option value="Monthly" ${item.frequency === 'Monthly' ? 'selected' : ''}>Monthly</option>
                            <option value="Yearly" ${item.frequency === 'Yearly' ? 'selected' : ''}>Yearly</option>
                        </select>
                    </td>
                    <td class="w-1/6 text-right">$${item.monthly.toFixed(2)}</td>
                    <td class="w-1/6 text-right">$${item.yearly.toFixed(2)}</td>
                    <td class="px-4 py-2 text-center">${removeButton}</td>
                </tr>
            `;
        }

        // Function to render income section
        function renderIncome() {
            const incomeBody = document.getElementById('incomeBody');
            incomeBody.innerHTML = ''; // Clear existing rows
            const initialCount = defaultBudgetData.income.length;
            window.budgetData.income.forEach((item, index) => {
                const isRemovable = index >= initialCount; // Only allow removal of dynamically added items
                incomeBody.innerHTML += renderItemRowHtml(item, index, 'income', isRemovable);
            });
            updateSummary();
        }

        // Function to render basic expenses section
        function renderBasicExpenses() {
            // Clear all basic expense table bodies first
            document.getElementById('housingBody').innerHTML = '';
            document.getElementById('maintenanceBody').innerHTML = '';
            document.getElementById('foodBody').innerHTML = '';
            document.getElementById('educationalBody').innerHTML = '';
            document.getElementById('utilitiesBody').innerHTML = '';
            document.getElementById('transportBody').innerHTML = '';
            document.getElementById('healthBody').innerHTML = '';
            document.getElementById('insuranceBody').innerHTML = '';
            document.getElementById('clothingBody').innerHTML = '';
            document.getElementById('otherBasicExpensesBody').innerHTML = ''; // Clear this too

            // Grouping for rendering based on item name
            const basicExpenseCategories = {
                'housingBody': ['Mortgage', 'Board', 'Rent'],
                'maintenanceBody': ['Security', 'Home Maintenance & Repairs', 'Major Improvements', 'Gardens and Fences', 'Pest Control', 'Electrical and Furniture Replacement', 'Linen and Utensils', 'Swimming Pool', 'Other (Maintenance)'],
                'foodBody': ['Groceries', 'Bought Meals', 'Coffee\'s Out & Snacks', 'Other (Food)'],
                'educationalBody': ['Study Course Fees', 'Professional Subscriptions', 'Student Union Fees', 'School Uniforms', 'Equipment and Tools', 'Books & Stationary', 'School Fees', 'Special Tuition (eg Music Lessons)', 'Excursions', 'Child Care', 'Other (Educational)'],
                'utilitiesBody': ['Rates & Water', 'Body Corporate', 'Electricity / Gas', 'Home Phone', 'Mobile Phone', 'Internet', 'Other (Utilities)'],
                'transportBody': ['Petrol', 'Registration', 'Motor Association', 'Maintenance & Repairs (Transport)', 'Public Transport', 'Parking Fees', 'Other (Transport)'],
                'healthBody': ['Dentist', 'Doctor', 'Optometrist', 'Chemist', 'Chiropractor', 'Physiotherapist', 'Specialists', 'Other (Health)'],
                'insuranceBody': ['Home & Contents', 'Medical (Insurance)', 'Vehicle (Insurance)', 'Boat & Caravan', 'Life (Insurance)', 'Income Protection', 'Other (Insurance)'],
                'clothingBody': ['Work Clothing or Uniform', 'Social Clothing', 'Sports Clothing', 'Footwear', 'Haircare', 'Makeup & Toiletries']
            };

            const initialCount = defaultBudgetData.basicExpenses.length;

            window.budgetData.basicExpenses.forEach((item, index) => {
                const isRemovable = index >= initialCount; // Only allow removal of dynamically added items
                let foundCategory = false;
                for (const tbodyId in basicExpenseCategories) {
                    if (basicExpenseCategories[tbodyId].includes(item.name)) {
                        document.getElementById(tbodyId).innerHTML += renderItemRowHtml(item, index, 'basicExpenses', isRemovable);
                        foundCategory = true;
                        break;
                    }
                }
                // If it's a dynamically added item that doesn't fit a specific sub-category,
                // add it to 'Other Basic Expenses'
                if (!foundCategory && isRemovable) {
                     document.getElementById('otherBasicExpensesBody').innerHTML += renderItemRowHtml(item, index, 'basicExpenses', isRemovable);
                }
            });
            updateSummary();
        }

        // Function to render lifestyle expenses section
        function renderLifestyleExpenses() {
            // Clear all lifestyle expense table bodies first
            document.getElementById('holidayBody').innerHTML = '';
            document.getElementById('giftsBody').innerHTML = '';
            document.getElementById('petsBody').innerHTML = '';
            document.getElementById('entertainmentBody').innerHTML = '';
            document.getElementById('hobbiesBody').innerHTML = '';
            document.getElementById('personalBody').innerHTML = '';
            document.getElementById('otherLifestyleExpensesBody').innerHTML = ''; // Clear this too

            // Grouping for rendering based on item name
            const lifestyleExpenseCategories = {
                'holidayBody': ['Travel fares & Fuel', 'Accommodation', 'Meals (Holiday)', 'Sightseeing', 'Other (Holiday)'],
                'giftsBody': ['Donations', 'Birthday Gifts', 'Birthday Parties', 'Christmas Gifts', 'Work related Gifts', 'Aniversaries', 'Weddings', 'Births and Christenings', 'Special Occasions', 'Pocket Money', 'Other (Gifts)'],
                'petsBody': ['Food (Pets)', 'Vet Fees', 'Medication and Treatment (Pets)', 'Registration (Pets)', 'Other (Pets)'],
                'entertainmentBody': ['Movies & Concerts', 'Video Hire', 'Music / CD\'s', 'Exhibitions and displays', 'Eating out', 'Takeaway Meals', 'Club Fees', 'Newspapers/magazines/books', 'Other (Entertainment)'],
                'hobbiesBody': ['Equipment Purchases', 'Equipment Hire', 'Fees (Hobbies)', 'Club Memberships (Hobbies)', 'Other (Hobbies)'],
                'personalBody': ['Alcohol', 'Cigarettes', 'Other (Personal)']
            };

            const initialCount = defaultBudgetData.lifestyleExpenses.length;

            window.budgetData.lifestyleExpenses.forEach((item, index) => {
                const isRemovable = index >= initialCount; // Only allow removal of dynamically added items
                let foundCategory = false;
                for (const tbodyId in lifestyleExpenseCategories) {
                    if (lifestyleExpenseCategories[tbodyId].includes(item.name)) {
                        document.getElementById(tbodyId).innerHTML += renderItemRowHtml(item, index, 'lifestyleExpenses', isRemovable);
                        foundCategory = true;
                        break;
                    }
                }
                 if (!foundCategory && isRemovable) {
                    // Fallback for dynamically added items not matching a subcategory
                    document.getElementById('otherLifestyleExpensesBody').innerHTML += renderItemRowHtml(item, index, 'lifestyleExpenses', isRemovable);
                }
            });
            updateSummary();
        }

        // Function to render loan repayments section
        function renderLoanRepayments() {
            const loanBody = document.getElementById('loanBody');
            loanBody.innerHTML = ''; // Clear existing rows
            const initialCount = defaultBudgetData.loanRepayments.length;
            window.budgetData.loanRepayments.forEach((item, index) => {
                const isRemovable = index >= initialCount; // Only allow removal of dynamically added items
                loanBody.innerHTML += renderItemRowHtml(item, index, 'loanRepayments', isRemovable);
            });
            updateSummary();
        }

        // NEW: Function to render savings goals section
        function renderSavingsGoals() {
            const savingsBody = document.getElementById('savingsBody');
            savingsBody.innerHTML = ''; // Clear existing rows
            const initialCount = defaultBudgetData.savingsGoals.length;
            window.budgetData.savingsGoals.forEach((item, index) => {
                const isRemovable = index >= initialCount; // Only allow removal of dynamically added items
                savingsBody.innerHTML += renderItemRowHtml(item, index, 'savingsGoals', isRemovable);
            });
            updateSummary();
        }


        // Function to render tax calculator section
        function renderTaxCalculator() {
            const beforeTaxInput = document.getElementById('beforeTaxAmount');
            const taxAmountDisplay = document.getElementById('taxAmountDisplay');
            const afterTaxAmountDisplay = document.getElementById('afterTaxAmountDisplay');

            // Only update the value if the input field is NOT currently focused to allow typing
            if (document.activeElement !== beforeTaxInput) {
                // Keep the raw number in the value while not focused, will be formatted on blur
                const displayBeforeTaxAmount = isNaN(window.budgetData.taxCalc.beforeTaxAmount) ? '0' : window.budgetData.taxCalc.beforeTaxAmount;
                beforeTaxInput.value = displayBeforeTaxAmount;
            }

            // Always recalculate tax based on the current value in budgetData
            const tax = window.calculateTax(window.budgetData.taxCalc.beforeTaxAmount);
            window.budgetData.taxCalc.taxAmount = tax;
            window.budgetData.taxCalc.afterTaxAmount = window.budgetData.taxCalc.beforeTaxAmount - tax;

            taxAmountDisplay.textContent = window.budgetData.taxCalc.taxAmount.toFixed(2);
            afterTaxAmountDisplay.textContent = window.budgetData.taxCalc.afterTaxAmount.toFixed(2);
        }

        // Function to calculate and update summary totals
        function updateSummary() {
            let totalIncome = 0;
            let totalExpenses = 0;
            let totalSavings = 0; // New total for savings
            const currentFrequencyKey = window.budgetData.summaryFrequency.toLowerCase(); // e.g., 'monthly'

            // Sum Income
            window.budgetData.income.forEach(item => {
                totalIncome += item[currentFrequencyKey];
            });

            // Sum Expenses
            window.budgetData.basicExpenses.forEach(item => {
                totalExpenses += item[currentFrequencyKey];
            });
            window.budgetData.lifestyleExpenses.forEach(item => {
                totalExpenses += item[currentFrequencyKey];
            });
            window.budgetData.loanRepayments.forEach(item => {
                totalExpenses += item[currentFrequencyKey];
            });

            // Sum Savings Goals
            window.budgetData.savingsGoals.forEach(item => {
                totalSavings += item[currentFrequencyKey];
            });


            const totalIncomeDisplay = document.getElementById('totalIncomeSummary');
            const totalExpensesDisplay = document.getElementById('totalExpensesSummary');
            const totalSavingsDisplay = document.getElementById('totalSavingsSummary'); // New display for savings
            const surplusDeficitDisplay = document.getElementById('surplusDeficitSummary');
            const summaryFrequencyLabel1 = document.getElementById('summaryFrequencyLabel1'); // For Income
            const summaryFrequencyLabel2 = document.getElementById('summaryFrequencyLabel2'); // For Expenses
            const summaryFrequencyLabel3 = document.getElementById('summaryFrequencyLabel3'); // For Surplus/Deficit
            const summaryFrequencyLabel4 = document.getElementById('summaryFrequencyLabel4'); // For Savings

            // Update the labels to reflect the current frequency
            if (summaryFrequencyLabel1) summaryFrequencyLabel1.textContent = `Total ${window.budgetData.summaryFrequency} `;
            if (summaryFrequencyLabel2) summaryFrequencyLabel2.textContent = `Total ${window.budgetData.summaryFrequency} `;
            if (summaryFrequencyLabel3) summaryFrequencyLabel3.textContent = `${window.budgetData.summaryFrequency} `;
            if (summaryFrequencyLabel4) summaryFrequencyLabel4.textContent = `Total ${window.budgetData.summaryFrequency} `; // For Savings


            totalIncomeDisplay.textContent = totalIncome.toFixed(2);
            totalExpensesDisplay.textContent = totalExpenses.toFixed(2);
            totalSavingsDisplay.textContent = totalSavings.toFixed(2); // Update savings display

            // Calculate surplus/deficit considering income, expenses, AND savings
            const surplusDeficit = totalIncome - totalExpenses - totalSavings;
            surplusDeficitDisplay.textContent = surplusDeficit.toFixed(2);
            surplusDeficitDisplay.classList.remove('surplus', 'deficit');
            if (surplusDeficit >= 0) {
                surplusDeficitDisplay.classList.add('surplus');
            } else {
                surplusDeficitDisplay.classList.add('deficit');
            }
            // Debounce the save operation
            debounceSaveData();
        }

        // --- Event Handlers for Budget Items ---

        // New: Updates the name of a budget item
        window.updateBudgetItemName = (category, index, value) => {
            if (window.budgetData[category] && window.budgetData[category][index]) {
                window.budgetData[category][index].name = value;
                // No need to re-render or update summary immediately, as only name changed
                // Data will be saved on amount blur or frequency change
            }
        };

        // Handles input changes for amount fields (updates data and summary, but not UI until blur)
        window.handleAmountInput = (element) => {
            const category = element.dataset.category;
            const index = parseInt(element.dataset.index);
            let item = window.budgetData[category][index];

            // Update the amount in the data model based on current input value
            item.amount = parseFloat(element.value) || 0; // Ensure it's a number, default to 0

            // Recalculate ALL frequency amounts for this item instantly
            const calculated = window.calculateAmounts(item.amount, item.frequency);
            item.weekly = calculated.weekly;
            item.fortnightly = calculated.fortnightly;
            item.monthly = calculated.monthly;
            item.yearly = calculated.yearly;

            // Update the summary immediately as user types
            updateSummary();
        };

        // Handles blur event for amount fields (triggers re-render for precise display and saves data)
        window.handleAmountBlur = (element) => {
            const category = element.dataset.category;
            // The index and item.amount are already updated by handleAmountInput.
            // Now, trigger the re-render of the specific section to format the number display.
            if (category === 'income') renderIncome();
            else if (category === 'basicExpenses') renderBasicExpenses();
            else if (category === 'lifestyleExpenses') renderLifestyleExpenses();
            else if (category === 'loanRepayments') renderLoanRepayments();
            else if (category === 'savingsGoals') renderSavingsGoals(); // New for savings goals

            // Save data to Firestore only after the user is done interacting with the field
            // No need to call debounceSaveData here as updateSummary already calls it.
            // if (db && userId && isAuthReady) {
            //     window.saveDataToFirestore();
            // }
        };

        // Handles frequency changes (triggers re-render and saves data)
        window.handleFrequencyChange = (element) => {
            const category = element.dataset.category;
            const index = parseInt(element.dataset.index);
            let item = window.budgetData[category][index];

            item.frequency = element.value;

            // Recalculate ALL frequency amounts for this item
            const calculated = window.calculateAmounts(item.amount, item.frequency);
            item.weekly = calculated.weekly;
            item.fortnightly = calculated.fortnightly;
            item.monthly = calculated.monthly;
            item.yearly = calculated.yearly;

            // Re-render the specific section
            if (category === 'income') renderIncome();
            else if (category === 'basicExpenses') renderBasicExpenses();
            else if (category === 'lifestyleExpenses') renderLifestyleExpenses();
            else if (category === 'loanRepayments') renderLoanRepayments();
            else if (category === 'savingsGoals') renderSavingsGoals(); // New for savings goals

            updateSummary();
            // Save data to Firestore
            // No need to call debounceSaveData here as updateSummary already calls it.
            // if (db && userId && isAuthReady) {
            //     window.saveDataToFirestore();
            // }
        };

        // Handles summary display frequency changes
        window.handleSummaryFrequencyChange = (element) => {
            window.budgetData.summaryFrequency = element.value;
            updateSummary();
            // No need to call debounceSaveData here as updateSummary already calls it.
            // if (db && userId && isAuthReady) {
            //     window.saveDataToFirestore();
            // }
        };

        // Handles input for tax calculator (updates data and summary, no re-render)
        window.handleTaxAmountInput = (element) => {
            const beforeTaxAmount = parseFloat(element.value);
            if (!isNaN(beforeTaxAmount) && beforeTaxAmount >= 0) {
                window.budgetData.taxCalc.beforeTaxAmount = beforeTaxAmount;
            } else {
                window.budgetData.taxCalc.beforeTaxAmount = 0; // Reset if invalid input
            }
            // Update the calculated tax and after-tax amounts immediately
            const tax = window.calculateTax(window.budgetData.taxCalc.beforeTaxAmount);
            window.budgetData.taxCalc.taxAmount = tax;
            window.budgetData.taxCalc.afterTaxAmount = window.budgetData.taxCalc.beforeTaxAmount - tax;

            // Update the display for tax and after-tax amounts instantly
            document.getElementById('taxAmountDisplay').textContent = window.budgetData.taxCalc.taxAmount.toFixed(2);
            document.getElementById('afterTaxAmountDisplay').textContent = window.budgetData.taxCalc.afterTaxAmount.toFixed(2);
        };

        // Handles blur for tax calculator (re-renders to format and saves data)
        window.handleTaxAmountBlur = (element) => {
            renderTaxCalculator(); // Re-render to format the input field and other displays
            // No need to call debounceSaveData here as updateSummary (which calls it)
            // is not directly related to tax calculation.
            if (db && userId && isAuthReady) {
                debounceSaveData(); // Call debounced save explicitly here
            }
        };

        // NEW: Generic function to add a new budget item
        window.addBudgetItem = (category) => {
            let newItem = { name: 'New Item', amount: 0, frequency: 'Monthly' };
            // Add calculated frequencies
            const calculated = window.calculateAmounts(newItem.amount, newItem.frequency);
            newItem.weekly = calculated.weekly;
            newItem.fortnightly = calculated.fortnightly;
            newItem.monthly = calculated.monthly;
            newItem.yearly = calculated.yearly;

            if (window.budgetData[category]) {
                window.budgetData[category].push(newItem);
                if (category === 'income') renderIncome();
                else if (category === 'basicExpenses') renderBasicExpenses(); // Add to basic expenses
                else if (category === 'savingsGoals') renderSavingsGoals();
                else if (category === 'lifestyleExpenses') renderLifestyleExpenses(); // For a separate 'add lifestyle expense' button
                else if (category === 'loanRepayments') renderLoanRepayments(); // For a separate 'add loan' button
                updateSummary();
                // No need to call debounceSaveData here as updateSummary already calls it.
                // window.saveDataToFirestore();
            } else {
                console.error("Attempted to add item to non-existent category:", category);
            }
        };

        // NEW: Generic function to remove a budget item
        window.removeBudgetItem = (category, index) => {
            let initialCount = 0;
            // Determine the number of pre-populated items for the given category
            if (defaultBudgetData[category]) {
                initialCount = defaultBudgetData[category].length;
            }

            if (window.budgetData[category] && index >= initialCount && index < window.budgetData[category].length) {
                window.budgetData[category].splice(index, 1);
                if (category === 'income') renderIncome();
                else if (category === 'basicExpenses') renderBasicExpenses();
                else if (category === 'lifestyleExpenses') renderLifestyleExpenses();
                else if (category === 'loanRepayments') renderLoanRepayments();
                else if (category === 'savingsGoals') renderSavingsGoals();
                updateSummary();
                // No need to call debounceSaveData here as updateSummary already calls it.
                // window.saveDataToFirestore();
            } else {
                showMessageBox("You cannot remove default pre-filled items. You can only remove items you've added yourself.");
            }
        };


        // Initial data setup based on provided CSVs for fresh start or missing data
        function initializeBudgetData() {
            // Apply default data if not already present in window.budgetData (e.g., first load without Firestore)
            // This ensures all items have the frequency fields and calculated amounts
            ['income', 'basicExpenses', 'lifestyleExpenses', 'loanRepayments', 'savingsGoals'].forEach(category => {
                if (!window.budgetData[category] || window.budgetData[category].length === 0) {
                    window.budgetData[category] = JSON.parse(JSON.stringify(defaultBudgetData[category]));
                }
                window.budgetData[category].forEach(item => {
                    // Ensure each item has calculated weekly, fortnightly, monthly, yearly values
                    if (typeof item.weekly === 'undefined' || typeof item.fortnightly === 'undefined' ||
                        typeof item.monthly === 'undefined' || typeof item.yearly === 'undefined') {
                        const calculated = window.calculateAmounts(item.amount, item.frequency);
                        item.weekly = calculated.weekly;
                        item.fortnightly = calculated.fortnightly;
                        item.monthly = calculated.monthly;
                        item.yearly = calculated.yearly;
                    }
                });
            });

            // Initialize tax calculator
            if (typeof window.budgetData.taxCalc === 'undefined') {
                window.budgetData.taxCalc = JSON.parse(JSON.stringify(defaultBudgetData.taxCalc));
            }
            const initialTaxCalc = window.budgetData.taxCalc;
            const tax = window.calculateTax(initialTaxCalc.beforeTaxAmount);
            initialTaxCalc.taxAmount = tax;
            initialTaxCalc.afterTaxAmount = initialTaxCalc.beforeTaxAmount - tax;
        }

        // Render all sections when the document is ready
        function renderAllData() {
            renderIncome();
            renderBasicExpenses();
            renderLifestyleExpenses();
            renderLoanRepayments();
            renderSavingsGoals(); // Render the new savings goals section
            renderTaxCalculator();
            updateSummary();

            // Set the summary frequency selector to the current value from budgetData
            const summaryFrequencySelect = document.getElementById('summaryFrequencySelect');
            if (summaryFrequencySelect && window.budgetData.summaryFrequency) {
                summaryFrequencySelect.value = window.budgetData.summaryFrequency;
            }
        }

        // --- Firestore Data Operations ---

        // Debounce mechanism for saving data
        let saveTimer;
        const DEBOUNCE_DELAY = 500; // milliseconds

        function debounceSaveData() {
            if (saveTimer) {
                clearTimeout(saveTimer);
            }
            saveTimer = setTimeout(() => {
                saveDataToFirestore();
            }, DEBOUNCE_DELAY);
        }

        // Function to save current budget data to Firestore
        window.saveDataToFirestore = async () => {
            if (!isAuthReady || !db || !userId || !appId) {
                console.log("Firestore not ready or user not authenticated. Data not saved.");
                return;
            }

            try {
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'budgetData', 'myBudget');
                // Ensure all items have necessary fields before saving, particularly the calculated frequencies
                const dataToSave = JSON.parse(JSON.stringify(window.budgetData)); // Deep copy to avoid modifying original
                ['income', 'basicExpenses', 'lifestyleExpenses', 'loanRepayments', 'savingsGoals'].forEach(category => {
                    dataToSave[category].forEach(item => {
                        const calculated = window.calculateAmounts(item.amount, item.frequency);
                        item.weekly = calculated.weekly;
                        item.fortnightly = calculated.fortnightly;
                        item.monthly = calculated.monthly;
                        item.yearly = calculated.yearly;
                    });
                });

                await setDoc(userDocRef, dataToSave);
                console.log("Budget data saved successfully to Firestore.");
            } catch (error) {
                console.error("Error saving budget data to Firestore:", error);
                showMessageBox(`Error saving your data: ${error.message}`);
            }
        };

        // Function to set up real-time listener for budget data from Firestore
        async function setupFirestoreListener() {
            if (!db || !userId || !appId) {
                console.warn("Cannot set up Firestore listener: DB or user ID not available.");
                return;
            }

            const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'budgetData', 'myBudget');

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    console.log("Budget data loaded from Firestore:", loadedData);

                    // Deep merge loaded data with default data to ensure all categories and their default fields are present
                    window.budgetData.income = loadedData.income && loadedData.income.length > 0 ? loadedData.income : JSON.parse(JSON.stringify(defaultBudgetData.income));
                    window.budgetData.basicExpenses = loadedData.basicExpenses && loadedData.basicExpenses.length > 0 ? loadedData.basicExpenses : JSON.parse(JSON.stringify(defaultBudgetData.basicExpenses));
                    window.budgetData.lifestyleExpenses = loadedData.lifestyleExpenses && loadedData.lifestyleExpenses.length > 0 ? loadedData.lifestyleExpenses : JSON.parse(JSON.stringify(defaultBudgetData.lifestyleExpenses));
                    window.budgetData.loanRepayments = loadedData.loanRepayments && loadedData.loanRepayments.length > 0 ? loadedData.loanRepayments : JSON.parse(JSON.stringify(defaultBudgetData.loanRepayments));
                    window.budgetData.savingsGoals = loadedData.savingsGoals && loadedData.savingsGoals.length > 0 ? loadedData.savingsGoals : JSON.parse(JSON.stringify(defaultBudgetData.savingsGoals));

                    // Merge taxCalc data, ensuring default structure if not present
                    window.budgetData.taxCalc = {
                        ...JSON.parse(JSON.stringify(defaultBudgetData.taxCalc)), // Start with default taxCalc
                        ...loadedData.taxCalc // Overlay with loaded taxCalc data
                    };

                    // Ensure summary frequency is loaded or defaults
                    window.budgetData.summaryFrequency = loadedData.summaryFrequency || defaultBudgetData.summaryFrequency;

                    // Re-calculate all frequency amounts for loaded items, just in case they were modified externally or missing
                    ['income', 'basicExpenses', 'lifestyleExpenses', 'loanRepayments', 'savingsGoals'].forEach(category => {
                        window.budgetData[category].forEach(item => {
                            const calculated = window.calculateAmounts(item.amount, item.frequency);
                            item.weekly = calculated.weekly;
                            item.fortnightly = calculated.fortnightly;
                            item.monthly = calculated.monthly;
                            item.yearly = calculated.yearly;
                        });
                    });

                } else {
                    console.log("No existing budget data found for this user. Initializing with default template.");
                    window.budgetData = JSON.parse(JSON.stringify(defaultBudgetData)); // Reset to full defaults
                    window.saveDataToFirestore(); // Save the default data for this new user
                }
                renderAllData(); // Render UI with loaded or default data
            }, (error) => {
                console.error("Error fetching budget data from Firestore:", error);
                showMessageBox(`Error loading your data: ${error.message}`);
                // If there's an error fetching, still initialize with defaults
                initializeBudgetData();
                renderAllData();
            });
        }

        // Run on window load
        window.onload = function() {
            initializeFirebase(); // This will trigger auth and then Firestore listener/initialization
        };
    </script>
</head>
<body class="p-4">
    <div class="message-box-overlay" id="messageBoxOverlay"></div>
    <div class="message-box" id="messageBox">
        <p id="messageBoxText" class="text-lg font-medium"></p>
        <button onclick="hideMessageBox()">OK</button>
    </div>

    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Rapid Value Calculator</h1>
        <p id="userIdDisplay" class="text-sm text-gray-500 text-center mb-6">User ID: Loading...</p>

        <!-- Overall Summary (Sticky Header Wrapper) -->
        <div class="sticky-header-wrapper">
            <div class="summary-box grid grid-cols-1 md:grid-cols-4 gap-4"> <!-- Changed to 4 columns for savings -->
                <div>
                    <p class="text-gray-600 text-lg mb-1"><span id="summaryFrequencyLabel1">Total Monthly </span> Income</p>
                    <p class="summary-value">$<span id="totalIncomeSummary">0.00</span></p>
                </div>
                <div>
                    <p class="text-gray-600 text-lg mb-1"><span id="summaryFrequencyLabel2">Total Monthly </span> Expenses</p>
                    <p class="summary-value">$<span id="totalExpensesSummary">0.00</span></p>
                </div>
                <div>
                    <p class="text-gray-600 text-lg mb-1"><span id="summaryFrequencyLabel4">Total Monthly </span> Savings</p> <!-- New Savings Summary -->
                    <p class="summary-value">$<span id="totalSavingsSummary">0.00</span></p>
                </div>
                <div>
                    <p class="text-gray-600 text-lg mb-1"><span id="summaryFrequencyLabel3">Monthly </span> Surplus/Deficit</p>
                    <p class="summary-value">$<span id="surplusDeficitSummary" class="surplus">0.00</span></p>
                </div>
            </div>
            <!-- Frequency Selector for Summary -->
            <div class="text-center mt-4">
                <label for="summaryFrequencySelect" class="font-medium text-gray-700 mr-2">Display Summary as:</label>
                <select id="summaryFrequencySelect" class="input-field inline-block w-auto" onchange="handleSummaryFrequencyChange(this)">
                    <option value="Weekly">Weekly</option>
                    <option value="Fortnightly">Fortnightly</option>
                    <option value="Monthly">Monthly</option>
                    <option value="Yearly">Yearly</option>
                </select>
            </div>
        </div>

        <!-- Instructions Section -->
        <div class="mb-8 p-6 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-lg">
            <h2 class="text-xl font-semibold mb-3">How to Use the Rapid Value Calculator</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                <div>
                    <p class="mb-2">This tool helps you manage your finances by tracking income, expenses, and savings goals, and calculating your estimated tax.</p>
                    <ul class="list-disc list-inside space-y-2 pl-4">
                        <li><strong>Income, Expenses, Savings Goals:</strong> Fill in the amounts for the pre-populated categories. Use the 'Frequency' dropdowns to specify if an amount is Weekly, Fortnightly, Monthly, or Yearly.</li>
                        <li><strong>Summary:</strong> The "Monthly Overview" at the top automatically updates, showing your total income, total expenses, total savings, and the final surplus or deficit. You can change the summary display frequency (Weekly, Fortnightly, Monthly, Yearly) using the dropdown below the summary box.</li>
                        <li><strong>Persistence:</strong> Your data is automatically saved as you make changes and will be loaded when you return.</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-lg mb-2">Adding & Removing Items:</h3>
                    <ul class="list-disc list-inside space-y-2 pl-4">
                        <li>To add a new income source, expense, or savings goal, simply click the <strong>'+ Add Income'</strong>, <strong>'+ Add Expense'</strong>, <strong>'+ Add Lifestyle Expense'</strong>, <strong>'+ Add Loan Repayment'</strong>, or <strong>'+ Add Saving Goal'</strong> buttons at the bottom of each respective section.</li>
                        <li>A new row will appear with a 'New Item' placeholder. Enter the name, amount, and select the frequency for your new entry.</li>
                        <li>You can remove any items you've added dynamically by clicking the <strong>'Remove'</strong> button next to them. Pre-populated default items cannot be removed, but their values can be edited.</li>
                    </ul>
                    <h3 class="font-semibold text-lg mt-4 mb-2">Using the Tax Calculator:</h3>
                    <ul class="list-disc list-inside space-y-2 pl-4">
                        <li>In the "NZ Tax Calculator" section, enter your estimated <strong>Annual Income Before Tax</strong>.</li>
                        <li>The tool will automatically calculate your estimated annual tax and your annual income after tax based on current NZ tax brackets.</li>
                    </ul>
                </div>
            </div>
        </div>


        <!-- Tax Calculator Section - Moved to top -->
        <section class="mb-8">
            <h2 class="section-title">Tax Calculator (NZ)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div class="flex flex-col gap-2">
                    <label for="beforeTaxAmount" class="font-medium text-gray-700">Annual Income Before Tax ($)</label>
                    <input type="number" step="0.01" id="beforeTaxAmount" value="55000"
                        class="input-field" oninput="handleTaxAmountInput(this)" onblur="handleTaxAmountBlur(this)">
                </div>
                <div class="flex flex-col gap-2">
                    <p class="font-medium text-gray-700">Estimated Annual Tax:</p>
                    <p class="text-2xl font-bold text-gray-800">$<span id="taxAmountDisplay">0.00</span></p>
                </div>
                <div class="col-span-1 md:col-span-2 flex flex-col gap-2 mt-4">
                    <p class="font-medium text-gray-700">Estimated Annual Income After Tax:</p>
                    <p class="text-3xl font-bold text-indigo-600">$<span id="afterTaxAmountDisplay">0.00</span></p>
                </div>
            </div>
            <div class="mt-6">
                <h3 class="subsection-title">NZ Tax Brackets (Effective from 31 July 2024)</h3>
                <ul class="list-disc list-inside text-gray-600">
                    <li>$0 - $15,600: 10.5%</li>
                    <li>$15,601 - $53,500: 17.5%</li>
                    <li>$53,501 - $78,100: 30%</li>
                    <li>$78,101 - $180,000: 33%</li>
                    <li>$180,000+: 39%</li>
                </ul>
            </div>
        </section>


        <!-- Income Section -->
        <section class="mb-8">
            <h2 class="section-title">Income</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th> <!-- Added for remove button -->
                        </tr>
                    </thead>
                    <tbody id="incomeBody">
                        <!-- Income rows will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <button onclick="addBudgetItem('income')" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                + Add Income
            </button>
        </section>

        <!-- Basic Expenses Section -->
        <section class="mb-8">
            <h2 class="section-title">Basic Expenses</h2>

            <h3 class="subsection-title">Housing</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="housingBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Maintenance</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="maintenanceBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Food</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="foodBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Educational & Professional</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="educationalBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Utilities</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="utilitiesBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Transport</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transportBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Health & Medical</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="healthBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Insurance</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="insuranceBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Clothing & Grooming</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clothingBody"></tbody>
                </table>
            </div>
            <!-- NEW: Generic table body for other basic expenses not fitting categories -->
            <h3 class="subsection-title">Other Basic Expenses</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="otherBasicExpensesBody"></tbody>
                </table>
            </div>

            <button onclick="addBudgetItem('basicExpenses')" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                + Add Expense
            </button>
        </section>

        <!-- Lifestyle Expenses Section -->
        <section class="mb-8">
            <h2 class="section-title">Lifestyle Expenses</h2>

            <h3 class="subsection-title">Holiday & Travel</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="holidayBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Gifts & Donations</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="giftsBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Pets</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="petsBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Entertainment</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="entertainmentBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Hobbies & Sports</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="hobbiesBody"></tbody>
                </table>
            </div>

            <h3 class="subsection-title">Personal</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="personalBody"></tbody>
                </table>
            </div>
            <!-- NEW: Generic table body for other lifestyle expenses not fitting categories -->
            <h3 class="subsection-title">Other Lifestyle Expenses</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="otherLifestyleExpensesBody"></tbody>
                </table>
            </div>
            <button onclick="addBudgetItem('lifestyleExpenses')" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                + Add Lifestyle Expense
            </button>
        </section>

        <!-- Loan Repayments Section -->
        <section class="mb-8">
            <h2 class="section-title">Loan Repayments</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loanBody">
                        <!-- Loan repayment rows will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <button onclick="addBudgetItem('loanRepayments')" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                + Add Loan Repayment
            </button>
        </section>

        <!-- NEW: Savings Goals Section -->
        <section class="mb-8">
            <h2 class="section-title">Savings Goals</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th>Goal</th>
                            <th>Amount</th>
                            <th>Frequency</th>
                            <th class="text-right">Monthly</th>
                            <th class="text-right">Yearly</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="savingsBody">
                        <!-- Savings goal rows will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <button onclick="addBudgetItem('savingsGoals')" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                + Add Saving Goal
            </button>
        </section>

    </div>
</body>
</html>
