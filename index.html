<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rapid Value Budgeting Tool</title>
<!-- Tailwind CSS CDN for styling -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Inter font from Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body {
font-family: 'Inter', sans-serif;
background-color: #f3f4f6; /* Light gray background */
color: #374151; /* Dark gray text */
}
.container {
max-width: 1200px;
margin: 2rem auto;
padding: 1.5rem;
background-color: #ffffff;
border-radius: 0.75rem; /* Rounded corners */
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}
.section-title {
font-size: 1.75rem;
font-weight: 700;
color: #1f2937;
margin-bottom: 1.5rem;
border-bottom: 2px solid #e5e7eb;
padding-bottom: 0.75rem;
}
.subsection-title {
font-size: 1.25rem;
font-weight: 600;
color: #4b5563;
margin-top: 1.5rem;
margin-bottom: 1rem;
}
.input-field {
padding: 0.6rem 0.8rem;
border: 1px solid #d1d5db;
border-radius: 0.5rem;
width: 100%;
transition: all 0.2s ease-in-out;
}
.input-field:focus {
outline: none;
border-color: #4f46e5;
box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}
.table-header th {
background-color: #e5e7eb;
padding: 0.8rem 1rem;
text-align: left;
font-weight: 600;
color: #4b5563;
border-bottom: 1px solid #d1d5db;
}
.table-row td {
padding: 0.75rem 1rem;
border-bottom: 1px solid #e5e7eb;
}
.table-row:last-child td {
border-bottom: none;
}
.total-row td {
font-weight: 600;
background-color: #f3f4f6;
}
.summary-box {
background-color: #ecf0f1; /* Lighter grey for summary */
border-radius: 0.75rem;
padding: 1.5rem;
margin-bottom: 2rem;
text-align: center;
}
.summary-value {
font-size: 2.25rem;
font-weight: 700;
color: #1f2937;
}
.surplus {
color: #10b981; /* Green for positive surplus */
}
.deficit {
color: #ef4444; /* Red for deficit */
}
.frequency-select {
appearance: none; /* Remove default arrow */
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='currentColor' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9' /%3E%3C/svg%3E");
background-repeat: no-repeat;
background-position: right 0.75rem center;
background-size: 1rem;
padding-right: 2.5rem; /* Make space for the custom arrow */
}
.message-box {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background-color: #ffffff;
border-radius: 0.75rem;
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
padding: 2rem;
z-index: 1000;
display: none; /* Hidden by default */
flex-direction: column;
align-items: center;
justify-content: center;
text-align: center;
min-width: 300px;
}
.message-box-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.5);
z-index: 999;
display: none; /* Hidden by default */
}
.message-box button {
background-color: #4f46e5;
color: white;
padding: 0.75rem 1.5rem;
border-radius: 0.5rem;
margin-top: 1rem;
cursor: pointer;
transition: background-color 0.2s ease-in-out;
}
.message-box button:hover {
background-color: #4338ca;
}

/* Sticky header styles */
.sticky-header-wrapper {
position: sticky;
top: 0;
z-index: 100; /* Ensure it stays above other content */
background-color: #f3f4f6; /* Match body background or set to white */
padding-top: 1rem; /* Add some space above the sticky element */
padding-bottom: 1rem; /* Add some space below the sticky element */
border-bottom: 1px solid #e5e7eb; /* Optional: A subtle line to separate */
margin-bottom: 2rem; /* Ensure space before content below it */
}
</style>
<!-- Firebase SDKs -->
<script type="module">
// Import necessary Firebase functions
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

let db;
let auth;
let userId = 'default-user-id'; // Default userId, will be updated on auth
let appId;
let isAuthReady = false; // Flag to ensure Firestore operations happen after auth

// Function to display custom message box
function showMessageBox(message) {
const msgBox = document.getElementById('messageBox');
const msgBoxText = document.getElementById('messageBoxText');
const msgBoxOverlay = document.getElementById('messageBoxOverlay');
msgBoxText.textContent = message;
msgBox.style.display = 'flex';
msgBoxOverlay.style.display = 'block';
}

// Function to hide custom message box
function hideMessageBox() {
const msgBox = document.getElementById('messageBox');
const msgBoxOverlay = document.getElementById('messageBoxOverlay');
msgBox.style.display = 'none';
msgBoxOverlay.style.display = 'none';
}
window.hideMessageBox = hideMessageBox; // Make it globally accessible

// Initialize Firebase and set up authentication
async function initializeFirebase() {
try {
// Accessing global variables provided by the Canvas environment
appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
console.warn("Firebase config is missing or incomplete. Data persistence will not work.");
showMessageBox("Error: Firebase configuration missing. Data will not be saved. You can still use the tool for calculations during this session.");
// Continue with initial data rendering even if Firebase init fails
initializeBudgetData();
renderAllData();
return; // Exit here, no need to proceed with Firebase app initialization or auth
}

const app = initializeApp(firebaseConfig);
db = getFirestore(app);
auth = getAuth(app);

// Set up authentication listener
onAuthStateChanged(auth, async (user) => {
if (user) {
userId = user.uid;
console.log("Authenticated user ID:", userId);
document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
isAuthReady = true;
setupFirestoreListener(); // Start listening for data once authenticated
} else {
// Attempt to sign in with custom token or anonymously
if (typeof __initial_auth_token !== 'undefined') {
try {
await signInWithCustomToken(auth, __initial_auth_token);
} catch (error) {
console.error("Error signing in with custom token:", error);
// Fallback to anonymous sign-in if custom token fails
await signInAnonymously(auth);
}
} else {
await signInAnonymously(auth);
}
}
});

} catch (error) {
console.error("Error initializing Firebase:", error);
showMessageBox("Error initializing application. Data persistence might be affected. You can still use the tool for calculations during this session.");
// Ensure initial data rendering happens even if there's a Firebase initialization error
initializeBudgetData();
renderAllData();
}
}

// Object to hold all budgeting data
window.budgetData = {
income: [],
basicExpenses: [],
lifestyleExpenses: [],
loanRepayments: [],
taxCalc: {
beforeTaxAmount: 55000,
taxAmount: 0,
afterTaxAmount: 0
},
summaryFrequency: 'Monthly' // New property for summary display frequency
};

// Function to set up Firestore snapshot listener
function setupFirestoreListener() {
if (!db || !userId || !isAuthReady) {
console.warn("Firestore not ready or user not authenticated. Skipping data listener setup.");
return;
}

const docRef = doc(db, "artifacts", appId, "users", userId, "budgetData", "currentBudget");

onSnapshot(docRef, (docSnap) => {
if (docSnap.exists()) {
const data = docSnap.data();
window.budgetData = JSON.parse(data.data); // Parse the stored JSON string
// Ensure new properties like summaryFrequency are set if old data doesn't have them
if (typeof window.budgetData.summaryFrequency === 'undefined') {
window.budgetData.summaryFrequency = 'Monthly';
}
console.log("Data loaded from Firestore:", window.budgetData);
renderAllData(); // Re-render the UI with loaded data
} else {
console.log("No budget data found in Firestore for this user. Starting with default values.");
                    saveDataToFirestore(); // Save initial empty state if no data exists
                    // No need to save initial state here, as renderAllData will be called and handles it
}
}, (error) => {
console.error("Error listening to Firestore document:", error);
@@ -334,7 +334,7 @@
let remainingIncome = income;

for (let i = 0; i < nzTaxBrackets.length; i++) {
                const bracket = nzTaxTaxBrackets[i];
                const bracket = nzTaxBrackets[i]; // Corrected typo: nzTaxTaxBrackets to nzTaxBrackets
const lowerBound = (i === 0) ? 0 : nzTaxBrackets[i - 1].income;
const upperBound = bracket.income;

@@ -356,7 +356,9 @@
// Helper to create a single table row HTML for an item
function renderItemRowHtml(item, originalIndex, category) {
// Ensure item.amount is a valid number before toFixed(2) is called for display
            const displayAmount = isNaN(item.amount) ? '0.00' : item.amount.toFixed(2);
            // The value attribute of the input reflects the actual number,
            // the display will be formatted on blur.
            const displayAmount = isNaN(item.amount) ? '0' : item.amount; // Changed to not format on input
return `
               <tr class="table-row">
                   <td class="w-1/3">${item.name}</td>
@@ -391,10 +393,7 @@
incomeBody.innerHTML += renderItemRowHtml(item, index, 'income');
});
updateSummary();
            // Only attempt to save if Firebase is properly initialized and authenticated
            if (db && userId && isAuthReady) {
                window.saveDataToFirestore();
            }
            // Removed saveDataToFirestore() from here
}

// Function to render basic expenses section
@@ -432,10 +431,7 @@
}
});
updateSummary();
            // Only attempt to save if Firebase is properly initialized and authenticated
            if (db && userId && isAuthReady) {
                window.saveDataToFirestore();
            }
            // Removed saveDataToFirestore() from here
}

// Function to render lifestyle expenses section
@@ -467,10 +463,7 @@
}
});
updateSummary();
            // Only attempt to save if Firebase is properly initialized and authenticated
            if (db && userId && isAuthReady) {
                window.saveDataToFirestore();
            }
            // Removed saveDataToFirestore() from here
}

// Function to render loan repayments section
@@ -481,10 +474,7 @@
loanBody.innerHTML += renderItemRowHtml(item, index, 'loanRepayments');
});
updateSummary();
            // Only attempt to save if Firebase is properly initialized and authenticated
            if (db && userId && isAuthReady) {
                window.saveDataToFirestore();
            }
            // Removed saveDataToFirestore() from here
}

// Function to render tax calculator section
@@ -496,7 +486,8 @@
// Only update the value if the input field is NOT currently focused to allow typing
// This is the key fix for the tax calculator input bug
if (document.activeElement !== beforeTaxInput) {
                const displayBeforeTaxAmount = isNaN(window.budgetData.taxCalc.beforeTaxAmount) ? '0.00' : window.budgetData.taxCalc.beforeTaxAmount.toFixed(2);
                // Keep the raw number in the value while not focused, will be formatted on blur
                const displayBeforeTaxAmount = isNaN(window.budgetData.taxCalc.beforeTaxAmount) ? '0' : window.budgetData.taxCalc.beforeTaxAmount;
beforeTaxInput.value = displayBeforeTaxAmount;
}

@@ -507,10 +498,7 @@

taxAmountDisplay.textContent = window.budgetData.taxCalc.taxAmount.toFixed(2);
afterTaxAmountDisplay.textContent = window.budgetData.taxCalc.afterTaxAmount.toFixed(2);
            // Only attempt to save if Firebase is properly initialized and authenticated
            if (db && userId && isAuthReady) {
                window.saveDataToFirestore();
            }
            // Removed saveDataToFirestore() from here
}

// Function to calculate and update summary totals
@@ -899,8 +887,7 @@
<h3 class="text-lg font-bold mb-2">How to Use the Tax Calculator</h3>
<p class="mb-2">This section allows you to calculate your estimated annual tax and after-tax income in New Zealand.</p>
<ol class="list-decimal list-inside pl-4">
                <li>**Locate the "Annual Income Before Tax ($)" field** further down this page in the "Tax Calculator (NZ)" section.</li>
                <li>**Enter your total annual income before tax** into this input field.</li>
                <li>**Enter your total annual income before tax** into the input field below.</li>
<li>**Click or tab out of the input field.** The tool will automatically calculate and display:
<ul class="list-disc list-inside pl-6 mt-1">
<li>Your **Estimated Annual Tax**.</li>
@@ -911,6 +898,36 @@
<p class="mt-2">This calculator uses the current New Zealand tax brackets to give you an estimate.</p>
</div>

        <!-- Tax Calculator Section - Moved to top -->
        <section class="mb-8">
            <h2 class="section-title">Tax Calculator (NZ)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div class="flex flex-col gap-2">
                    <label for="beforeTaxAmount" class="font-medium text-gray-700">Annual Income Before Tax ($)</label>
                    <input type="number" step="0.01" id="beforeTaxAmount" value="55000"
                        class="input-field" oninput="handleTaxAmountInput(this)" onblur="handleTaxAmountBlur(this)">
                </div>
                <div class="flex flex-col gap-2">
                    <p class="font-medium text-gray-700">Estimated Annual Tax:</p>
                    <p class="text-2xl font-bold text-gray-800">$<span id="taxAmountDisplay">0.00</span></p>
                </div>
                <div class="col-span-1 md:col-span-2 flex flex-col gap-2 mt-4">
                    <p class="font-medium text-gray-700">Estimated Annual Income After Tax:</p>
                    <p class="text-3xl font-bold text-indigo-600">$<span id="afterTaxAmountDisplay">0.00</span></p>
                </div>
            </div>
            <div class="mt-6">
                <h3 class="subsection-title">NZ Tax Brackets (Effective from 31 July 2024)</h3>
                <ul class="list-disc list-inside text-gray-600">
                    <li>$0 - $15,600: 10.5%</li>
                    <li>$15,601 - $53,500: 17.5%</li>
                    <li>$53,501 - $78,100: 30%</li>
                    <li>$78,101 - $180,000: 33%</li>
                    <li>$180,000+: 39%</li>
                </ul>
            </div>
        </section>


<!-- Income Section -->
<section class="mb-8">
@@ -1204,36 +1221,6 @@
</div>
</section>

        <!-- Tax Calculator Section -->
        <section class="mb-8">
            <h2 class="section-title">Tax Calculator (NZ)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div class="flex flex-col gap-2">
                    <label for="beforeTaxAmount" class="font-medium text-gray-700">Annual Income Before Tax ($)</label>
                    <input type="number" step="0.01" id="beforeTaxAmount" value="55000.00"
                        class="input-field" oninput="handleTaxAmountInput(this)" onblur="handleTaxAmountBlur(this)">
                </div>
                <div class="flex flex-col gap-2">
                    <p class="font-medium text-gray-700">Estimated Annual Tax:</p>
                    <p class="text-2xl font-bold text-gray-800">$<span id="taxAmountDisplay">0.00</span></p>
                </div>
                <div class="col-span-1 md:col-span-2 flex flex-col gap-2 mt-4">
                    <p class="font-medium text-gray-700">Estimated Annual Income After Tax:</p>
                    <p class="text-3xl font-bold text-indigo-600">$<span id="afterTaxAmountDisplay">0.00</span></p>
                </div>
            </div>
            <div class="mt-6">
                <h3 class="subsection-title">NZ Tax Brackets (Effective from 31 July 2024)</h3>
                <ul class="list-disc list-inside text-gray-600">
                    <li>$0 - $15,600: 10.5%</li>
                    <li>$15,601 - $53,500: 17.5%</li>
                    <li>$53,501 - $78,100: 30%</li>
                    <li>$78,101 - $180,000: 33%</li>
                    <li>$180,000+: 39%</li>
                </ul>
            </div>
        </section>

</div>
</body>
</html>
